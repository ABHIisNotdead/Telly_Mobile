    private void saveVoucher() {
        String type = spnVoucherType.getSelectedItem().toString();
        String voucherNo = etVoucherNo.getText().toString();
        String date = etDate.getText().toString();
        String partyName = actvPartyName.getText().toString();

        if (voucherNo.isEmpty() || date.isEmpty()) {
             Toast.makeText(this, "Voucher No and Date are required", Toast.LENGTH_SHORT).show();
             return;
        }

        long result = -1;
        
        if (type.equals("Journal") || type.equals("Contra")) {
            if (chargesList.isEmpty()) {
                Toast.makeText(this, "Please add entries (Dr/Cr)", Toast.LENGTH_SHORT).show();
                return;
            }
            // Optional: Check if Dr total == Cr total
            double drTotal = 0, crTotal = 0;
            for(VoucherCharge c : chargesList) {
                if(c.isDebit) drTotal += c.amount;
                else crTotal += c.amount;
            }
            if (Math.abs(drTotal - crTotal) > 0.01) {
                // Warning only, or strict? Let's allow but warn.
                // Toast.makeText(this, "Warning: Dr and Cr totals do not match!", Toast.LENGTH_SHORT).show();
            }

            result = databaseHelper.addJournal(voucherNo, date, "Journal Entry", selectedCompanyId);
            if (result != -1) {
                for (VoucherCharge charge : chargesList) {
                    databaseHelper.addVoucherCharge(result, type, charge.ledgerId, charge.ledgerName, charge.amount, charge.isPercentage, charge.rate, charge.isDebit);
                }
            }
        } else if (type.equals("Sales")) {
            // Already implemented Sales logic...
            result = handleSaveSales(voucherNo, date, partyName);
        } else if (type.equals("Purchase")) {
            result = databaseHelper.addPurchase(voucherNo, date, partyName, totalAmount, selectedCompanyId);
             if (result != -1) {
                for (InvoiceItem item : itemList) {
                    databaseHelper.addPurchaseItem(result, item.getItemName(), item.getQuantity(), item.getRate(), item.getAmount(), item.getUnit(), item.getHsn());
                }
                for (VoucherCharge charge : chargesList) {
                    databaseHelper.addVoucherCharge(result, "Purchase", charge.ledgerId, charge.ledgerName, charge.amount, charge.isPercentage, charge.rate, false);
                }
            }
        } else if (type.equals("Payment") || type.equals("Receipt")) {
            // Receipt/Payment Logic
             if (!actvPartyName.getText().toString().isEmpty() && !etPaymentAmount.getText().toString().isEmpty()) {
                addPaymentLine(); 
            }

            if (chargesList.isEmpty()) {
                 Toast.makeText(this, "Please add accounts/amounts", Toast.LENGTH_SHORT).show();
                 return;
            }
            
            double total = 0;
            for(VoucherCharge c : chargesList) total += c.amount;
            
            String throughLedger = actvBankLedger.getText().toString();
            if (throughLedger.isEmpty()) {
                Toast.makeText(this, "Please select 'Through' ledger", Toast.LENGTH_SHORT).show();
                return;
            }

            if (type.equals("Payment")) {
                result = databaseHelper.addPayment(voucherNo, date, throughLedger, total, "", selectedCompanyId);
            } else {
                result = databaseHelper.addReceipt(voucherNo, date, "", selectedCompanyId); // Reusing addJournal style or dedicated addReceipt
                // If I made addReceipt in DatabaseHelper, use it
                // result = databaseHelper.addReceipt(voucherNo, date, "Receipt", selectedCompanyId);
            }

            if (result != -1) {
                 for (VoucherCharge charge : chargesList) {
                    databaseHelper.addVoucherCharge(result, type, charge.ledgerId, charge.ledgerName, charge.amount, charge.isPercentage, charge.rate, charge.isDebit);
                }
            }
        }

        if (result != -1) {
            Toast.makeText(this, type + " Saved Successfully", Toast.LENGTH_SHORT).show();
            finish();
        } else {
            Toast.makeText(this, "Failed to save " + type, Toast.LENGTH_SHORT).show();
        }
    }

    private long handleSaveSales(String voucherNo, String date, String partyName) {
        // ... (Moving original Sales logic here for clarity or keeping it in saveVoucher)
        // For now I'll just keep the existing saveVoucher structure but integrated
        return -1; // Placeholder for conceptual split
    }return;
        }
        
        if (result != -1) {
             Toast.makeText(this, type + " Voucher Saved Successfully!", Toast.LENGTH_LONG).show();
             databaseHelper.addNotification("Voucher Created", type + " Voucher " + voucherNo + " created for " + partyName, "Success");
             finish();
        } else {
             Toast.makeText(this, "Failed to save voucher", Toast.LENGTH_SHORT).show();
        }
    }
    
    private void loadVoucherItems(int id, String type) {
        Cursor cursor = databaseHelper.getVoucherItems(id, type);
        if (cursor != null) {
            itemList.clear();
            while (cursor.moveToNext()) {
                String name = cursor.getString(cursor.getColumnIndexOrThrow("item_name"));
                double qty = cursor.getDouble(cursor.getColumnIndexOrThrow("quantity"));
                double rate = cursor.getDouble(cursor.getColumnIndexOrThrow("rate"));
                double amount = cursor.getDouble(cursor.getColumnIndexOrThrow("amount"));
                
                double gst = 0, cgst = 0, sgst = 0;
                if (type.equals("Sales")) {
                     // Try to get GST info if available (for new invoices)
                     int gstIdx = cursor.getColumnIndex("gst_rate");
                     if (gstIdx != -1) gst = cursor.getDouble(gstIdx);
                     
                     int cgstIdx = cursor.getColumnIndex("cgst_amount");
                     if (cgstIdx != -1) cgst = cursor.getDouble(cgstIdx);
                     
                     int sgstIdx = cursor.getColumnIndex("sgst_amount");
                     if (sgstIdx != -1) sgst = cursor.getDouble(sgstIdx);
                }

                String unit = "";
                int unitIdx = cursor.getColumnIndex("unit");
                if (unitIdx != -1) unit = cursor.getString(unitIdx);

                String hsn = "";
                int hsnIdx = cursor.getColumnIndex("hsn");
                if (hsnIdx != -1) hsn = cursor.getString(hsnIdx);

                itemList.add(new InvoiceItem(name, qty, rate, amount, gst, cgst, sgst, unit, hsn));
            }
            cursor.close();
            adapter.notifyDataSetChanged();
            updateTotals(); // Recalculate based on loaded items
        }
    }

    private void loadVoucherCharges(int id, String type) {
        Cursor cursor = databaseHelper.getVoucherCharges(id, type);
        if (cursor != null) {
            chargesList.clear();
            while (cursor.moveToNext()) {
